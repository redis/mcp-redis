  name: Release to PyPI
  
  on:
    release:
      types: [published]
    workflow_dispatch:
      inputs:
        version:
          description: 'Version to release (e.g., 0.3.0)'
          required: true
          type: string
        environment:
          description: 'Target environment'
          required: true
          default: 'pypi'
          type: choice
          options:
          - pypi
          - testpypi
        dry_run:
          description: 'Dry run (build only, do not publish)'
          required: false
          default: false
          type: boolean
  
  permissions:
    contents: read
  
  jobs:
    validate-release:
      runs-on: ubuntu-latest
      outputs:
        version: ${{ steps.get-version.outputs.version }}
        tag-version: ${{ steps.get-version.outputs.tag-version }}
      steps:
      - name: âš™ï¸ Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
  
      - name: âš™ï¸ Checkout the project
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for UV build
  
      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: false
  
      - name: âš™ï¸ Set up Python
        run: uv python install 3.12
  
    security-scan:
      runs-on: ubuntu-latest
      needs: validate-release
      steps:
      - name: âš™ï¸ Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
  
      - name: âš™ï¸ Checkout the project
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
  
      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: false
  
      - name: âš™ï¸ Set Python up and add dependencies
        run: |
          uv python install 3.12
          uv sync --all-extras --dev
          uv add --dev bandit
  
      - name: âš™ï¸ Run security scan with bandit
        run: |
          uv run bandit -r src/
  
    test:
      runs-on: ubuntu-latest
      needs: validate-release
      strategy:
        matrix:
          python-version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
  
      services:
        redis:
          image: redis:latest
          ports:
            - 6379:6379
          options: >-
            --health-cmd "redis-cli ping"
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
  
      steps:
      - name: âš™ï¸ Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
  
      - name: âš™ï¸ Checkout the project
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
  
      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: false
  
      - name: âš™ï¸ Set up Python ${{ matrix.python-version }}
        run: |
          uv python install ${{ matrix.python-version }}
          uv sync --all-extras --dev
  
      - name: âš™ï¸ Run tests
        run: uv run pytest tests/ -v --tb=short
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
  
      - name: âš™ï¸ Test MCP server startup
        run: |
          timeout 10s uv run python src/main.py || test $? = 124
        env:
          REDIS_HOST: localhost
          REDIS_PORT: 6379
  
    build-and-publish:
      runs-on: ubuntu-latest
      needs: [validate-release, security-scan, test]
      environment:
        name: ${{ github.event.inputs.environment || 'pypi' }}
        url: ${{ github.event.inputs.environment == 'testpypi' && 'https://test.pypi.org/p/redis-mcp-server' || 'https://pypi.org/p/redis-mcp-server' }}
      permissions:
        id-token: write  # IMPORTANT: mandatory for trusted publishing
        contents: read
        attestations: write  # For build attestations
  
      steps:
      - name: âš™ï¸ Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
  
      - name: âš™ï¸ Checkout the project
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for UV build
  
      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"
          enable-cache: false
  
      - name: âš™ï¸ Set up Python
        run: uv python install 3.12
  
      - name: âš™ï¸ Override version in pyproject.toml
        if: (github.event_name == 'workflow_dispatch' && github.event.inputs.version) || github.event_name == 'release'
        run: |
          # Determine the target version
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET_VERSION="${{ github.event.inputs.version }}"
            echo "Overriding version from manual trigger: $TARGET_VERSION"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            TARGET_VERSION=$(echo "$RELEASE_TAG" | sed 's/^v//')
            echo "Overriding version from release tag: $TARGET_VERSION (tag: $RELEASE_TAG)"
          fi
            
          # Get current version for comparison
          CURRENT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "Current version in pyproject.toml: $CURRENT_VERSION"
            
          # Check if override is needed
          if [[ "$CURRENT_VERSION" == "$TARGET_VERSION" ]]; then
            echo "Version already matches target: $TARGET_VERSION"
          else
            echo "Version override needed: $CURRENT_VERSION â†’ $TARGET_VERSION"
            
            # Update version in pyproject.toml
            sed -i "s/^version = \".*\"/version = \"$TARGET_VERSION\"/" pyproject.toml
            
            # Verify the change
            NEW_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
            echo "Updated version in pyproject.toml: $NEW_VERSION"
            
            # Validate the change was successful
            if [[ "$NEW_VERSION" != "$TARGET_VERSION" ]]; then
              echo "Version override failed! Expected: $TARGET_VERSION, Got: $NEW_VERSION"
              exit 1
            fi
            
            echo "Version successfully changed: $CURRENT_VERSION â†’ $NEW_VERSION"
          fi
  
      - name: âš™ï¸ Build package
        run: |
          uv build --sdist --wheel
  
      - name: âš™ï¸ Check package
        run: |
          uv add --dev twine
          uv run twine check dist/*
  
      - name: âš™ï¸ Generate build attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/*'
  
      - name: âš™ï¸ Publish to PyPI
        if: ${{ !inputs.dry_run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: ${{ github.event.inputs.environment == 'testpypi' && 'https://test.pypi.org/legacy/' || '' }}
          print-hash: true
          attestations: true
  
      - name: âš™ï¸ Dry run - Package ready for publishing
        if: ${{ inputs.dry_run }}
        run: |
          echo "ğŸ” DRY RUN MODE - Package built successfully but not published"
          echo "ğŸ“¦ Built packages:"
          ls -la dist/
          echo ""
          echo "âœ… Package is ready for publishing to ${{ github.event.inputs.environment || 'pypi' }}"
  
      - name: âš™ï¸ Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: dist-${{ needs.validate-release.outputs.version }}
          path: dist/
          retention-days: 90

    publish-mcp-registry:
      runs-on: ubuntu-latest
      needs: [validate-release, build-and-publish]
      if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && !inputs.dry_run) }}
      permissions:
        id-token: write  # Required for GitHub OIDC authentication
        contents: read

      steps:
      - name: âš™ï¸ Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: âš™ï¸ Checkout the project
        uses: actions/checkout@v5

      - name: âš™ï¸ Verify server.json exists and is valid JSON
        run: |
          if [ ! -f server.json ]; then
            echo "Error: server.json not found"
            exit 1
          fi

          if ! jq empty server.json 2>/dev/null; then
            echo "Error: server.json is not valid JSON"
            exit 1
          fi

          echo "Success: server.json is valid JSON"
          echo "Original server.json:"
          cat server.json

      - name: âš™ï¸ Update server.json version
        run: |
          # Determine the target version
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TARGET_VERSION="${{ github.event.inputs.version }}"
            echo "Using version from manual trigger: $TARGET_VERSION"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            TARGET_VERSION=$(echo "$RELEASE_TAG" | sed 's/^v//')
            echo "Using version from release tag: $TARGET_VERSION (tag: $RELEASE_TAG)"
          else
            echo "Error: Unexpected event type: ${{ github.event_name }}"
            exit 1
          fi

          # Update version in server.json (with validation)
          if ! jq --arg v "$TARGET_VERSION" '.version = $v | .packages[0].version = $v' server.json > tmp; then
            echo "Error: jq failed to update server.json"
            rm -f tmp
            exit 1
          fi

          # Verify the updated content is valid JSON before replacing
          if ! jq empty tmp 2>/dev/null; then
            echo "Error: Updated server.json is not valid JSON"
            cat tmp
            rm -f tmp
            exit 1
          fi

          # Replace original with validated update
          mv tmp server.json

          echo "Updated server.json:"
          cat server.json

      - name: âš™ï¸ Install MCP Publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xzf - mcp-publisher
          chmod +x mcp-publisher

      - name: âš™ï¸ Login to MCP Registry
        if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != true) }}
        run: ./mcp-publisher login github-oidc

      - name: âš™ï¸ Publish to MCP Registry
        if: ${{ github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run != true) }}
        run: ./mcp-publisher publish

      - name: âš™ï¸ Dry run notification
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
        run: |
          VERSION=$(jq -r '.version' server.json)
          echo "ğŸ” DRY RUN MODE - MCP Registry preparation successful!"
          echo ""
          echo "server.json is valid JSON and ready to publish"
          echo "Server: io.github.redis/mcp-redis"
          echo "Version: $VERSION"
          echo ""
          echo "To actually publish to MCP Registry, run this workflow again without dry_run enabled"

    notify-success:
      runs-on: ubuntu-latest
      needs: [validate-release, build-and-publish, publish-mcp-registry]
      if: success()
      steps:
      - name: âš™ï¸ Success notification
        run: |
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ” DRY RUN COMPLETED - Redis MCP Server v${{ github.event.inputs.version || needs.validate-release.outputs.version }} ready for release!"
            echo "ğŸ“¦ Package built successfully but not published"
            echo "ğŸ¯ Target environment: ${{ github.event.inputs.environment || 'pypi' }}"
          else
            echo "ğŸ‰ Successfully released Redis MCP Server v${{ github.event.inputs.version || needs.validate-release.outputs.version }}!"
            echo ""
            echo "ğŸ“¦ PyPI Package:"
            if [[ "${{ github.event.inputs.environment }}" == "testpypi" ]]; then
              echo "   https://test.pypi.org/project/redis-mcp-server/${{ github.event.inputs.version || needs.validate-release.outputs.version }}/"
            else
              echo "   https://pypi.org/project/redis-mcp-server/${{ github.event.inputs.version || needs.validate-release.outputs.version }}/"
            fi
            echo ""
            echo "ğŸ”Œ MCP Registry:"
            echo "   https://registry.modelcontextprotocol.io/v0/servers?search=redis"
            echo ""
            if [[ "${{ github.event_name }}" == "release" ]]; then
              echo "ğŸ·ï¸ Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            else
              echo "ğŸš€ Manual release triggered by: ${{ github.actor }}"
            fi
          fi
